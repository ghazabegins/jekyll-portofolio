<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Laporan - Admin</title>
    <script> if (sessionStorage.getItem('isOwnerLoggedIn') !== 'true') { window.location.href = "input.html"; } </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* CSS SAMA, HANYA TAMBAH STYLE BADGE USER */
        body { background-color: #f4f6f8; font-family: 'Poppins', sans-serif; padding-bottom: 80px; }
        .app-header { background: white; padding: 20px; text-align: center; border-radius: 0 0 30px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; position: relative; }
        .page-title { font-weight: 800; color: #2c3e50; margin: 0; font-size: 1.2rem; text-transform: uppercase; }
        .page-subtitle { font-size: 0.8rem; color: #888; }
        .btn-logout { position: absolute; top: 20px; right: 20px; font-size: 0.75rem; font-weight: bold; color: #dc3545; background: #fff0f0; border: none; padding: 5px 12px; border-radius: 15px; }
        .table-card { background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 20px; border: 1px solid #eee; }
        .table-responsive { max-height: 70vh; overflow-y: auto; }
        .table thead th { position: sticky; top: 0; z-index: 20; border: none; font-size: 0.7rem; text-transform: uppercase; padding: 12px 5px; white-space: nowrap; text-align: center !important; vertical-align: middle; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .table tbody td { vertical-align: middle; font-size: 0.85rem; padding: 10px 5px; white-space: nowrap; border-bottom: 1px solid #f0f0f0; text-align: center !important; }
        .table tfoot th { position: sticky; bottom: 0; z-index: 20; background: #2c3e50; color: #fff; font-size: 0.75rem; padding: 15px 5px; text-align: center !important; border-top: 2px solid #ddd; }
        .ft-total-ps { color: #6ea8fe; font-weight: 800; font-size: 0.85rem; }
        .ft-total-fnb { color: #75b798; font-weight: 800; font-size: 0.85rem; }
        .bg-ps-light { background-color: #f2f8ff !important; }
        .val-ps-total { color: #0d6efd; font-weight: 800; }
        .bg-fnb-light { background-color: #f2fff6 !important; }
        .val-fnb-total { color: #198754; font-weight: 800; }
        .col-date { font-weight: 600; color: #444; }
        .btn-action { border: none; width: 32px; height: 32px; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; margin: 0 2px; transition: transform 0.2s;}
        .btn-action:active { transform: scale(0.9); }
        .btn-edit { background: #fff3cd; color: #856404; }
        .btn-del { background: #f8d7da; color: #721c24; }
        #loading-state { padding: 50px; text-align: center; color: #888; }
        .fab-back { position: fixed; bottom: 25px; right: 25px; width: 55px; height: 55px; background: #2c3e50; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 20px rgba(44,62,80,0.4); text-decoration: none; z-index: 999; }
        
        .user-pill { background: #e9ecef; color: #495057; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .swal2-input-group { margin-bottom: 10px; text-align: left; }
        .swal2-label { font-size: 0.8rem; color: #666; font-weight: 600; display: block; margin-bottom: 3px; }
        .swal2-input-custom { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        .group-header { font-weight: 800; margin: 15px 0 5px; font-size: 0.9rem; text-transform: uppercase; border-bottom: 2px solid #eee; padding-bottom: 5px; }
    </style>
</head>
<body>

<div class="app-header">
    <button onclick="logout()" class="btn-logout">ðŸ”’ Logout</button>
    <h1 class="page-title">Data Laporan</h1>
    <p class="page-subtitle mb-0">Admin Access</p>
</div>

<div class="container-fluid px-2">
    <div class="table-card">
        <div id="loading-state"><div class="spinner-border text-primary mb-3" role="status"></div><p class="small fw-bold">Mengambil data...</p></div>
        <div class="table-responsive" id="data-container" style="display: none;">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="background: #34495e; color: white;">AKSI</th>
                        <th style="min-width: 80px; background: #34495e; color: white;">TGL</th>
                        <th style="background: #34495e; color: white;">USER</th> <th class="bg-primary text-white" colspan="3">RENTAL PS</th>
                        <th class="bg-success text-white" colspan="3">FNB</th>
                    </tr>
                    <tr style="font-size: 0.65rem;">
                        <th style="background: #f8f9fa;"></th>
                        <th style="background: #f8f9fa;"></th>
                        <th style="background: #f8f9fa;"></th>
                        <th class="bg-ps-light text-primary">TOTAL</th>
                        <th class="bg-ps-light text-muted">Cash</th>
                        <th class="bg-ps-light text-muted">QRIS</th>
                        <th class="bg-fnb-light text-success">TOTAL</th>
                        <th class="bg-fnb-light text-muted">Cash</th>
                        <th class="bg-fnb-light text-muted">QRIS</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
                <tfoot>
                    <tr>
                        <th style="background: #212529;" colspan="3">TOTAL</th>
                        <th style="background: #212529;" class="ft-total-ps" id="sum-ps-total">0</th>
                        <th style="background: #212529;" id="sum-ps-cash">0</th>
                        <th style="background: #212529;" id="sum-ps-qris">0</th>
                        <th style="background: #212529;" class="ft-total-fnb" id="sum-fnb-total">0</th>
                        <th style="background: #212529;" id="sum-fnb-cash">0</th>
                        <th style="background: #212529;" id="sum-fnb-qris">0</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<a href="input.html" class="fab-back" title="Kembali Input">âž•</a>

<script>
    // --- âš ï¸ PASTE URL WEB APP DISINI ---
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyr4HaHcMknb_g9XmR-vZHbNCWSaIl1VokxtwVmmg1RuBeFWW1xQIM7_kM-sWXczCe1/exec'; 
    // ---------------------------------

    function logout() { sessionStorage.removeItem('isOwnerLoggedIn'); window.location.href = "index.html"; }
    const formatTanggalIndo = (d) => { if(!d) return '-'; const date = new Date(d); if(isNaN(date.getTime())) return '-'; return date.toLocaleDateString('id-ID', {day:'2-digit', month:'2-digit', year:'2-digit'}); };
    const fmt = (v) => { let n = Number(v); return (v==="" || v===null || isNaN(n) || n===0) ? '-' : n.toLocaleString('id-ID'); };

    function loadData() {
        document.getElementById('loading-state').style.display = 'block';
        document.getElementById('data-container').style.display = 'none';

        fetch(scriptURL)
            .then(res => res.json())
            .then(res => {
                if (res.status === 'success') {
                    const rawData = res.data; 
                    
                    const cleanData = rawData.filter(item => item.values[0] && new Date(item.values[0]).toString() !== 'Invalid Date');
                    cleanData.sort((a, b) => new Date(a.values[0]) - new Date(b.values[0]));

                    let html = '';
                    let total = { ps_all:0, ps_cash:0, ps_qris:0, fnb_all:0, fnb_cash:0, fnb_qris:0 };

                    cleanData.forEach(item => {
                        const row = item.values; 
                        const idx = item.excel_row_index; 
                        
                        total.ps_all += Number(row[1])||0; total.ps_cash += Number(row[2])||0; total.ps_qris += Number(row[3])||0;
                        total.fnb_all += Number(row[4])||0; total.fnb_cash += Number(row[5])||0; total.fnb_qris += Number(row[6])||0;

                        const rawDate = new Date(row[0]);
                        const dateIso = rawDate.getFullYear() + '-' + String(rawDate.getMonth() + 1).padStart(2, '0') + '-' + String(rawDate.getDate()).padStart(2, '0');
                        
                        // row[7] adalah Kolom H (User)
                        const userBadge = row[7] ? `<span class="user-pill">${row[7]}</span>` : '-';

                        const rowJson = JSON.stringify({ idx: idx, date: dateIso, ps_t: row[1], ps_c: row[2], ps_q: row[3], fnb_t: row[4], fnb_c: row[5], fnb_q: row[6] }).replace(/"/g, '&quot;');

                        html += `
                            <tr>
                                <td>
                                    <button class="btn-action btn-edit" onclick="openEditModal(${rowJson})">âœŽ</button>
                                    <button class="btn-action btn-del" onclick="deleteRow(${idx})">ðŸ—‘</button>
                                </td>
                                <td class="col-date">${formatTanggalIndo(row[0])}</td>
                                <td>${userBadge}</td> <td class="bg-ps-light val-ps-total">${fmt(row[1])}</td>
                                <td class="bg-ps-light text-muted small">${fmt(row[2])}</td>
                                <td class="bg-ps-light text-muted small">${fmt(row[3])}</td>
                                <td class="bg-fnb-light val-fnb-total">${fmt(row[4])}</td>
                                <td class="bg-fnb-light text-muted small">${fmt(row[5])}</td>
                                <td class="bg-fnb-light text-muted small">${fmt(row[6])}</td>
                            </tr>
                        `;
                    });

                    document.getElementById('tableBody').innerHTML = html;
                    document.getElementById('sum-ps-total').innerText = fmt(total.ps_all);
                    document.getElementById('sum-ps-cash').innerText = fmt(total.ps_cash);
                    document.getElementById('sum-ps-qris').innerText = fmt(total.ps_qris);
                    document.getElementById('sum-fnb-total').innerText = fmt(total.fnb_all);
                    document.getElementById('sum-fnb-cash').innerText = fmt(total.fnb_cash);
                    document.getElementById('sum-fnb-qris').innerText = fmt(total.fnb_qris);

                    document.getElementById('loading-state').style.display = 'none';
                    document.getElementById('data-container').style.display = 'block';
                } else {
                    document.getElementById('loading-state').innerHTML = '<p>Belum ada data.</p>';
                }
            });
    }

    window.deleteRow = (rowIndex) => {
        Swal.fire({ title: 'Hapus data?', text: "Data tidak bisa dikembalikan!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Hapus' }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({title: 'Menghapus...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() }});
                fetch(scriptURL, { method: 'POST', body: JSON.stringify({ action: 'delete', row_index: rowIndex }) })
                .then(res => res.json()).then(res => { Swal.fire('Terhapus!', '', 'success'); loadData(); })
                .catch(err => Swal.fire('Error', 'Gagal menghapus.', 'error'));
            }
        });
    };

    window.openEditModal = (data) => {
        Swal.fire({
            title: 'Edit Data',
            html: `
                <div class="swal2-input-group"><label class="swal2-label">Tanggal</label><input type="date" id="edit-date" class="swal2-input-custom" value="${data.date}"></div>
                <div class="group-header text-primary">RENTAL PS</div>
                <div class="d-flex gap-2"><div style="flex:1"><label class="swal2-label">Total</label><input type="number" id="edit-ps-t" class="swal2-input-custom" value="${data.ps_t}"></div><div style="flex:1"><label class="swal2-label">Cash</label><input type="number" id="edit-ps-c" class="swal2-input-custom" value="${data.ps_c}"></div><div style="flex:1"><label class="swal2-label">QRIS</label><input type="number" id="edit-ps-q" class="swal2-input-custom" value="${data.ps_q}"></div></div>
                <div class="group-header text-success">FNB / MAKANAN</div>
                <div class="d-flex gap-2"><div style="flex:1"><label class="swal2-label">Total</label><input type="number" id="edit-fnb-t" class="swal2-input-custom" value="${data.fnb_t}"></div><div style="flex:1"><label class="swal2-label">Cash</label><input type="number" id="edit-fnb-c" class="swal2-input-custom" value="${data.fnb_c}"></div><div style="flex:1"><label class="swal2-label">QRIS</label><input type="number" id="edit-fnb-q" class="swal2-input-custom" value="${data.fnb_q}"></div></div>
            `,
            width: '600px', showCancelButton: true, confirmButtonText: 'Simpan', confirmButtonColor: '#2c3e50',
            preConfirm: () => {
                return {
                    action: 'update', row_index: data.idx, tanggal: document.getElementById('edit-date').value,
                    ps_total: document.getElementById('edit-ps-t').value, ps_cash: document.getElementById('edit-ps-c').value, ps_qris: document.getElementById('edit-ps-q').value,
                    fnb_total: document.getElementById('edit-fnb-t').value, fnb_cash: document.getElementById('edit-fnb-c').value, fnb_qris: document.getElementById('edit-fnb-q').value,
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({title: 'Menyimpan...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() }});
                fetch(scriptURL, { method: 'POST', body: JSON.stringify(result.value) })
                .then(res => res.json()).then(res => { Swal.fire('Berhasil', '', 'success'); loadData(); })
                .catch(err => Swal.fire('Error', 'Gagal update.', 'error'));
            }
        });
    };
    loadData();
</script>

</body>
</html>